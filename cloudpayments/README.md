# CloudPayments модуль для Drupal7 - Ubercart
### Совместимость:
* Drupal v.7.x;
* Ubercart v.3.11;
Модуль тестировался на Ubercart v.3.11

### Возможности:  
• Одностадийная схема оплаты;  
• Двухстадийная схема оплаты;  
• Отмена, подтверждение и возврат платежей из ЛК CMS;  
• Поддержка онлайн-касс (ФЗ-54);  
• Отправка чеков по email;  
• Отправка чеков по SMS;  


### Установка
Для установки данного модуля необходимо распаковать содержимое архива в папку `/sites/all/modules` вашего сайта и активировать модули из административной панели.
Примечание. Для перевода интерфейса модуля на русский язык необходимо активировать модуль `Locale`, и импортировать файл `cloudpayments.ru.po` через меню `Конфигурация`-`Перевод интерфейса`- вкладка `Импорт`.

### Настройка модуля
Далее заполните и сохраните настройки на странице /admin/config/system/cloudpayments.

![1](img/1.png)
![2](img/2.png)

Описание настроек:
* **Public_id** — Public id сайта из личного кабинета CloudPayments;
* **Password for API** — API Secret из личного кабинета CloudPayments;
* **Схемы проведения платежа** — выбор одностадийной или двухстадийной схемы;
* **Отправка чеков** — Включение/отключение формирования онлайн-чека при оплате;
* **Система налогооблажения** — Тип системы налогообложения;
* **Ставка НДС для товаров** — Указание ставки НДС товаров;
* **Ставка налога для доставки** — Указание ставки НДС службы доставки;

Для одностадийной схемы оплаты достаточно  выбрать и настроить статусы:
* **Заказ Оплачен** - заказ переходит в этот статус, когда происходит списание енежных средств со счёта покупателя;
* **Статус оформленного (неоплаченного) заказа** - модуль переводит заказ в этот статус, если оплата не совершена;
* **Возврат заказа** - перевод в этот статус выполняет возврат денежных средств на счет покупателя;
Для Двухстадийной схемы оплаты необходимо дополнительно  выбрать следующие статусы:
* **Статус авторизованного платежа (DMS)** - статус при котором банком холдируются средства на счёте покупателя, но требуют вашего подтверждения для списания.
* **Статус подтвержденного платежа (DMS)** - статус для подтверждения (функция работает только для аторизованного платежа)
* **Заказ отменён (DMS)** - статус для отмены авторизованных денежных средств. (функция работает только для аторизованного платежа)
* **Поле для телефона** - Позволяет выполнять отправку чеков по SMS вашим клиентам, если поле с номером телефона добавлено [стандартным способом](https://docs.drupalcommerce.org/commerce1/user-guide/customer-profiles/configuring--creating-customer-profiles);

В случае если вы настраивали налоги через модуль Ubercart ([скриншот](https://prnt.sc/iu5aaz)), то в настройках CloudPayments необходимо указать "Take from setting" (Брать из настроек) ([скриншот](https://prnt.sc/iu5bmj)), в потивном случае платежи не будут проходить.
Если цены товаров указаны уже с учетом налогов (https://prnt.sc/iu5cvy), то в настройках CloudPayments выберите необходимый показатель (https://prnt.sc/iu5de1).


### Настройка вебхуков:

В [личном кабинете](https://merchant.cloudpayments.ru/Account/Login) CloudPayments в настройках вашего сайта вставьте следующие URL для коректной работы модуля:
* (Check) 		http(s)://yourdomainname.ru/cloudpayments/check
* (Pay) 		http(s)://yourdomainname.ru/cloudpayments/pay
* (Confirm)		http(s)://yourdomainname.ru/cloudpayments/confirm
* (Refund)		http(s)://yourdomainname.ru/cloudpayments/refund
![3](img/3.png)
где yourdomainname.ru - доменное имя вашего сайта.